cloud_provider:
  cert: ((mbus_cert))
  mbus: https://mbus:((mbus_password))@((vpn_external_ip)):6868
  properties:
    agent:
      mbus: https://mbus:((mbus_password))@0.0.0.0:6868
    aws:
      access_key_id: ((access_key_id))
      default_key_name: ((default_key_name))
      default_security_groups: ((default_security_groups))
      region: ((region))
      secret_access_key: ((secret_access_key))
    blobstore:
      path: /var/vcap/micro_bosh/data/cache
      provider: local
  ssh_tunnel:
    host: ((vpn_external_ip))
    port: 22
    private_key: ((private_key))
    user: vcap
  template:
    name: aws_cpi
    release: bosh-aws-cpi
instance_groups:
- instances: 1
  jobs:
  - name: openvpn-clients
    properties:
      configs:
        - |
          client
          group nogroup
          user nobody
          persist-key
          persist-tun
          verb 3
          mute 20
          mute-replay-warnings
          nobind
          resolv-retry infinite
          remote-random
          remote-cert-tls server
          remote ((remote_vpn_ip)) 1194 tcp
          cipher AES-256-CBC
          keysize 256
          tls-client
          tls-cipher DEFAULT:!EXP:!LOW:!MEDIUM
          tls-version-min 1.2
          <ca>
          ((client_key_pair.ca))
          </ca>
          <cert>
          ((client_key_pair.certificate))
          </cert>
          <key>
          ((client_key_pair.private_key))
          </key>
    release: openvpn
  - name: openvpn
    properties:
      dh_pem: |
        -----BEGIN DH PARAMETERS-----
        MIIBCAKCAQEA/oih/YXvkf13npOIF5LW170/V5j4R20NjL/IzgdZUYMlsQtm5zMZ
        LwA8Vk1v9UnSWkopAGuJ8gZxz4qKk2p2MLzHSDwXC5khGrrJlHfjn7H0lYilyFqn
        2YhmfCQ7z7ih0jUS/iNf/+xUmfoJn/2OMEY3gmcAxAbtVRqNtGFwsTjtap3Rgbt9
        /j7Xbrsp3JqSeWN3VSqMzAgUrjkkkv52HcDo4zA1KfN7m+ROj/uGxcrmvZr7G0RK
        9yJ2f8I1x8EW3p+CmWhHcmoNyxxlfRHIsZ+82+BIessN99pSxCbjWvhggntFLRwC
        fcrq5wk9ei7dzYjZHSPHqvhmmZgWKJZYQwIBAg==
        -----END DH PARAMETERS-----
      push_routes:
      - ((lan_network)) ((lan_network_mask))
      server: ((vpn_network)) ((vpn_network_mask))
      tls_server: ((server_key_pair))
    release: openvpn
  - name: disable_agent
    properties: {}
    release: os-conf
  - name: iptables
    properties:
      iptables:
        filter:
          FORWARD:
          - -s ((vpn_network))/((vpn_network_mask_bits)) -d ((lan_network))/((lan_network_mask_bits))
            -m conntrack --ctstate NEW -j ACCEPT -m comment --comment 'vpn -> lan'
          - -s ((lan_network))/((lan_network_mask_bits)) -d ((vpn_network))/((vpn_network_mask_bits))
            -m conntrack --ctstate NEW -j ACCEPT -m comment --comment 'lan -> vpn'
          - -m conntrack --ctstate RELATED,ESTABLISHED -j ACCEPT
    release: networking
  name: openvpn
  networks:
  - default:
    - dns
    - gateway
    name: default
    static_ips:
    - ((vpn_internal_ip))
  - name: vip
    static_ips:
    - ((vpn_external_ip))
  resource_pool: default
  stemcell: default
name: openvpn
networks:
- name: default
  subnets:
  - cloud_properties:
      subnet: ((subnet_id))
    dns:
    - 8.8.8.8
    gateway: ((internal_gw))
    range: ((lan_network))/((lan_network_mask_bits))
    static:
    - ((vpn_internal_ip))
  type: manual
- name: vip
  static_ips:
  - ((vpn_external_ip))
  type: vip
releases:
- name: openvpn
  url: file:///tmp/vpn.tgz
  # sha1: 19e79e45b690bc933b0ff5d9e54574f25d0899b9
  # url: https://s3-external-1.amazonaws.com/dpb587-bosh-release-openvpn-us-east-1/compiled_releases/openvpn/openvpn-4.0.0-on-ubuntu-trusty-stemcell-3421.11-compiled-1.20170630134749.0.tgz
- name: os-conf
  sha1: 651f10a765a2900a7f69ea07705f3367bd8041eb
  url: https://bosh.io/d/github.com/cloudfoundry/os-conf-release?v=11
  version: 11
- name: bosh-aws-cpi
  sha1: 26b3a5c43e6f82594a373309a495660d6db26254
  url: https://bosh.io/d/github.com/cloudfoundry-incubator/bosh-aws-cpi-release?v=65
  version: 65
- name: networking
  sha1: 9b5f9d27917c3754e492470ac6c9af80d62963db
  url: http://bosh.io/d/github.com/cloudfoundry/networking-release?v=9
  version: 9
resource_pools:
- cloud_properties:
    availability_zone: ((az))
    instance_type: t2.nano
    source_dest_check: false
  env:
    bosh:
      mbus:
        cert: ((mbus_cert))
  name: default
  network: default
  stemcell:
    sha1: 98f9b71398f0f771e8a4bbaf5531440b99bae540
    url: https://bosh.io/d/stemcells/bosh-aws-xen-hvm-ubuntu-trusty-go_agent?v=3421.11
update:
  canaries: 1
  canary_watch_time: 1000-60000
  max_in_flight: 1
  update_watch_time: 1000-60000
variables:
- name: ca
  type: certificate
  options:
    is_ca: true
    common_name: ca
- name: mbus_password
  type: password
- name: mbus_cert
  type: certificate
  options:
    ca: ca
    alternative_names:
    - ((vpn_internal_ip))
    - ((vpn_external_ip))
    common_name: ((vpn_external_ip))
- name: server_key_pair
  type: certificate
  options:
    ca: ca
    common_name: openvpn
    alternative_names:
    - ((vpn_external_ip))
    extended_key_usage:
    - server_auth
  type: certificate
- name: client_key_pair
  type: certificate
  options:
    ca: ca
    common_name: openvpn-client
    extended_key_usage:
    - client_auth
  type: certificate
- name: ssh_tunnel
  type: ssh
